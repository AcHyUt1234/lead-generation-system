name: Lead Generation Pipeline

on:
  workflow_dispatch:

jobs:
  generate-leads:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas requests anthropic
    
    - name: Verify files exist
      run: |
        echo "=== Checking repository structure ==="
        ls -la
        echo ""
        echo "=== Checking for required files ==="
        if [ -f "apollo_enricher.py" ]; then
          echo "✓ apollo_enricher.py found"
        else
          echo "✗ apollo_enricher.py NOT found"
        fi
        if [ -f "lead_generation_pipeline.py" ]; then
          echo "✓ lead_generation_pipeline.py found"
        else
          echo "✗ lead_generation_pipeline.py NOT found"
        fi
    
    - name: Verify API keys are set
      run: |
        echo "=== Checking API keys ==="
        if [ -n "$APOLLO_API_KEY" ]; then
          echo "✓ APOLLO_API_KEY is set (length: ${#APOLLO_API_KEY})"
        else
          echo "✗ APOLLO_API_KEY is NOT set"
        fi
        if [ -n "$ANTHROPIC_API_KEY" ]; then
          echo "✓ ANTHROPIC_API_KEY is set (length: ${#ANTHROPIC_API_KEY})"
        else
          echo "✗ ANTHROPIC_API_KEY is NOT set"
        fi
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        APOLLO_API_KEY: ${{ secrets.APOLLO_API_KEY }}
    
    - name: Create outputs directory
      run: |
        mkdir -p outputs
        echo "✓ Created outputs directory"
        ls -la
    
    - name: Run lead generation pipeline
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        APOLLO_API_KEY: ${{ secrets.APOLLO_API_KEY }}
        HUBSPOT_API_KEY: ${{ secrets.HUBSPOT_API_KEY }}
      run: |
        echo "=== Starting pipeline ==="
        python lead_generation_pipeline.py
        echo "=== Pipeline finished ==="
    
    - name: Check for output files
      if: always()
      run: |
        echo "=== Checking outputs directory ==="
        if [ -d "outputs" ]; then
          echo "✓ outputs directory exists"
          echo "Contents:"
          ls -la outputs/
          if [ -f outputs/*.csv ]; then
            echo "✓ CSV file(s) found:"
            ls -lh outputs/*.csv
          else
            echo "✗ No CSV files found in outputs/"
          fi
        else
          echo "✗ outputs directory does not exist"
        fi
        echo ""
        echo "=== Checking current directory ==="
        echo "All files in current directory:"
        ls -la
    
    - name: Upload CSV results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lead-export-${{ github.run_number }}
        path: outputs/*.csv
        retention-days: 90
        if-no-files-found: warn
    
    - name: Upload debug logs (if CSV not found)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: debug-logs-${{ github.run_number }}
        path: |
          outputs/
          *.log
        retention-days: 30
        if-no-files-found: ignore
